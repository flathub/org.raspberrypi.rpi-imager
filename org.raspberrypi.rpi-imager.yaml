app-id: org.raspberrypi.rpi-imager
runtime: org.kde.Platform
runtime-version: '6.9'
sdk: org.kde.Sdk
command: rpi-imager
rename-icon: rpi-imager
finish-args:
  - --device=all
  - --device=dri
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=wayland
  - --socket=pulseaudio
  - --filesystem=/media
  - --filesystem=/run/media
  - --talk-name=org.a11y.*
  - --talk-name=org.freedesktop.Notifications
  - --system-talk-name=org.freedesktop.UDisks2
modules:
  - name: rpi-imager
    config-opts:
      - -DENABLE_CHECK_VERSION:BOOL=OFF
      - -DENABLE_TELEMETRY:BOOL=OFF
      - -DCMAKE_BUILD_TYPE=MinSizeRel
      - -DFETCHCONTENT_FULLY_DISCONNECTED=ON
      - -DFETCHCONTENT_SOURCE_DIR_XZ=_deps/xz-src
      - -DFETCHCONTENT_SOURCE_DIR_ZSTD=_deps/zstd-src
      - -DFETCHCONTENT_SOURCE_DIR_NGHTTP2=_deps/nghttp2-src
      - -DFETCHCONTENT_SOURCE_DIR_ZLIB=_deps/zlib-src
      - -DFETCHCONTENT_SOURCE_DIR_LIBARCHIVE=_deps/libarchive-src
    buildsystem: cmake-ninja
    builddir: false
    subdir: src
    post-install:
      - rm ${FLATPAK_DEST}/share/metainfo/*.metainfo.xml
      - install -Dm644 -t "${FLATPAK_DEST}/share/metainfo" "../${FLATPAK_ID}.metainfo.xml"
      - desktop-file-edit --set-key=Exec --set-value='/app/bin/rpi-imager %F' "${FLATPAK_DEST}/share/applications/org.raspberrypi.rpi-imager.desktop"
    sources:
      - type: archive
        url: https://github.com/raspberrypi/rpi-imager/archive/refs/tags/v1.9.6.tar.gz
        sha256: dbaef70eaeeec7bab95adb677681ef3bdb63c5568b53915fde78276c04421ed3
        x-checker-data:
          type: json
          url: https://api.github.com/repos/raspberrypi/rpi-imager/releases/latest
          version-query: .tag_name | sub("^v"; "")
          timestamp-query: .published_at
          url-query: |
            "https://github.com/raspberrypi/rpi-imager/archive/refs/tags/v" + $version + ".tar.gz"

      # Pre-populate XZ/LZMA dependency
      - type: git
        url: https://github.com/tukaani-project/xz.git
        tag: v5.8.1
        commit: a522a226545730551f7e7c2685fab27cf567746c
        dest: src/_deps/xz-src

      # Pre-populate zstd dependency
      - type: git
        url: https://github.com/facebook/zstd.git
        tag: v1.5.7
        commit: f8745da6ff1ad1e7bab384bd1f9d742439278e99
        dest: src/_deps/zstd-src

      # Pre-populate nghttp2 dependency
      - type: git
        url: https://github.com/nghttp2/nghttp2.git
        tag: v1.66.0
        commit: ac22e0efe3f82f43c1366961c89a50ee821cfba3
        dest: src/_deps/nghttp2-src

      # Pre-populate zlib dependency - use specific commit hash
      - type: git
        url: https://github.com/madler/zlib.git
        commit: 5a82f71ed1dfc0bec044d9702463dbdf84ea3b71
        dest: src/_deps/zlib-src

      # Pre-populate libarchive dependency
      - type: git
        url: https://github.com/libarchive/libarchive.git
        tag: v3.8.1
        commit: 9525f90ca4bd14c7b335e2f8c84a4607b0af6bdf
        dest: src/_deps/libarchive-src
      - type: file
        path: org.raspberrypi.rpi-imager.metainfo.xml

      - type: patch
        path: remove-vendoring.patch